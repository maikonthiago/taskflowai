{% extends "base.html" %}

{% block title %}Gerenciar Usuários - Admin TaskFlowAI{% endblock %}

{% block content %}
<div class="d-flex" id="wrapper">
    <!-- Sidebar -->
    <div class="bg-dark border-end" id="sidebar-wrapper"
        style="width: 250px; position: fixed; height: 100vh; z-index: 1000;">
        <div class="sidebar-heading text-white border-bottom border-secondary p-3 d-flex align-items-center gap-2">
            <i class="bi bi-shield-lock-fill text-warning"></i>
            <span class="fw-bold">Admin Panel</span>
        </div>
        <div class="list-group list-group-flush pt-3">
            <a href="{{ url_for('admin_dashboard') }}"
                class="list-group-item list-group-item-action bg-dark text-white-50 border-0 py-3">
                <i class="bi bi-speedometer2 me-2"></i> Visão Geral
            </a>
            <a href="{{ url_for('admin_users') }}"
                class="list-group-item list-group-item-action bg-dark text-white-50 border-0 py-3 active">
                <i class="bi bi-people me-2"></i> Usuários
            </a>
            <a href="{{ url_for('admin_financial') }}"
                class="list-group-item list-group-item-action bg-dark text-white-50 border-0 py-3">
                <i class="bi bi-credit-card me-2"></i> Financeiro
            </a>
            <a href="{{ url_for('admin_settings') }}"
                class="list-group-item list-group-item-action bg-dark text-white-50 border-0 py-3">
                <i class="bi bi-gear me-2"></i> Configurações
            </a>
            <div class="mt-auto border-top border-secondary pt-3 mt-3 px-3">
                <a href="{{ url_for('dashboard') }}" class="btn btn-outline-light w-100 btn-sm">
                    <i class="bi bi-arrow-left"></i> Voltar ao App
                </a>
            </div>
        </div>
    </div>

    <!-- Page Content -->
    <div id="page-content-wrapper" style="margin-left: 250px; width: 100%;">
        <!-- Topbar -->
        <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom py-3 px-4">
            <div class="container-fluid">
                <h4 class="mb-0 fw-bold">Gerenciar Usuários</h4>
                <div class="dropdown">
                    <button class="btn btn-light dropdown-toggle d-flex align-items-center gap-2" type="button"
                        id="adminDropdown" data-bs-toggle="dropdown">
                        <div class="bg-danger rounded-circle text-white d-flex align-items-center justify-content-center"
                            style="width: 32px; height: 32px;">
                            <i class="bi bi-person-fill"></i>
                        </div>
                        Admin
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item text-danger" href="{{ url_for('logout') }}">Sair</a></li>
                    </ul>
                </div>
            </div>
        </nav>

        <div class="container-fluid px-4 py-4">
            <!-- Search & Filters -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body p-4">
                    <form method="GET" action="{{ url_for('admin_users') }}" class="row g-3">
                        <div class="col-md-6">
                            <div class="input-group">
                                <span class="input-group-text bg-light border-end-0"><i class="bi bi-search"></i></span>
                                <input type="text" name="search" class="form-control bg-light border-start-0"
                                    placeholder="Buscar por nome ou email..."
                                    value="{{ request.args.get('search', '') }}">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <select name="plan" class="form-select bg-light">
                                <option value="">Todos os Planos</option>
                                <option value="free" {% if request.args.get('plan')=='free' %}selected{% endif %}>
                                    Gratuito</option>
                                <option value="pro" {% if request.args.get('plan')=='pro' %}selected{% endif %}>Pro
                                </option>
                                <option value="business" {% if request.args.get('plan')=='business' %}selected{% endif
                                    %}>Business</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <button type="submit" class="btn btn-primary-custom w-100 fw-bold">Filtrar</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Users Table -->
            <div class="card border-0 shadow-sm">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th class="px-4 py-3 text-muted small text-uppercase">Usuário</th>
                                <th class="py-3 text-muted small text-uppercase">Plano</th>
                                <th class="py-3 text-muted small text-uppercase">Status</th>
                                <th class="py-3 text-muted small text-uppercase">Projetos</th>
                                <th class="py-3 text-muted small text-uppercase">Data Registro</th>
                                <th class="px-4 py-3 text-muted small text-uppercase text-end">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in users.items %}
                            <tr>
                                <td class="px-4">
                                    <div class="d-flex align-items-center gap-3">
                                        <div class="bg-light rounded-circle d-flex align-items-center justify-content-center fw-bold text-primary"
                                            style="width: 40px; height: 40px;">
                                            {{ user.username[0]|upper }}
                                        </div>
                                        <div>
                                            <div class="fw-bold text-dark">{{ user.full_name }}</div>
                                            <small class="text-muted">{{ user.email }}</small>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    {% if user.subscription_plan == 'pro' %}
                                    <span
                                        class="badge bg-primary-subtle text-primary border border-primary-subtle px-3 py-1 rounded-pill">Pro</span>
                                    {% elif user.subscription_plan == 'business' %}
                                    <span
                                        class="badge bg-warning-subtle text-warning border border-warning-subtle px-3 py-1 rounded-pill">Business</span>
                                    {% else %}
                                    <span
                                        class="badge bg-secondary-subtle text-secondary border border-secondary-subtle px-3 py-1 rounded-pill">Gratuito</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if user.is_active %}
                                    <span class="d-flex align-items-center gap-2"><span
                                            class="bg-success rounded-circle" style="width: 8px; height: 8px;"></span>
                                        Ativo</span>
                                    {% else %}
                                    <span class="d-flex align-items-center gap-2"><span class="bg-danger rounded-circle"
                                            style="width: 8px; height: 8px;"></span> Inativo</span>
                                    {% endif %}
                                </td>
                                <td>{{ user.projects|length }}</td>
                                <td class="text-muted">{{ user.created_at.strftime('%d/%m/%Y') }}</td>
                                <td class="px-4 text-end">
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-light border" type="button"
                                            data-bs-toggle="dropdown">
                                            <i class="bi bi-three-dots"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end">
                                            <li><a class="dropdown-item" href="#">Editar</a></li>
                                            <li><a class="dropdown-item" href="#">Mudar Plano</a></li>
                                            <li>
                                                <hr class="dropdown-divider">
                                            </li>
                                            <li>
                                                <form
                                                    action="{{ url_for('admin_toggle_user_status', user_id=user.id) }}"
                                                    method="POST" style="display: inline;">
                                                    <button type="submit" class="dropdown-item text-danger">
                                                        {% if user.is_active %}Desativar{% else %}Ativar{% endif %}
                                                    </button>
                                                </form>
                                            </li>
                                        </ul>
                                    </div>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="6" class="text-center py-5 text-muted">Nenhum usuário encontrado.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <!-- Pagination -->
                <div class="card-footer bg-white py-3">
                    <nav aria-label="Page navigation">
                        <ul class="pagination justify-content-center mb-0">
                            {% if users.has_prev %}
                            <li class="page-item"><a class="page-link"
                                    href="{{ url_for('admin_users', page=users.prev_num, search=request.args.get('search'), plan=request.args.get('plan')) }}">Anterior</a>
                            </li>
                            {% else %}
                            <li class="page-item disabled"><span class="page-link">Anterior</span></li>
                            {% endif %}

                            <li class="page-item active"><span class="page-link">{{ users.page }} de {{ users.pages
                                    }}</span></li>

                            {% if users.has_next %}
                            <li class="page-item"><a class="page-link"
                                    href="{{ url_for('admin_users', page=users.next_num, search=request.args.get('search'), plan=request.args.get('plan')) }}">Próxima</a>
                            </li>
                            {% else %}
                            <li class="page-item disabled"><span class="page-link">Próxima</span></li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}