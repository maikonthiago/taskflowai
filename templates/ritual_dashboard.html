{% extends "base.html" %}

{% block content %}
{% include 'includes/user_navbar.html' %}
<div class="container mx-auto px-4 py-8 max-w-3xl">
    <!-- Header Zen -->
    <div class="flex justify-between items-center mb-12">
        <div>
            <h1 class="text-3xl font-light text-gray-800 dark:text-gray-100 mb-2">RitualOS</h1>
            <p class="text-gray-500 italic" id="date-display"></p>
        </div>
        <div class="flex gap-2 items-center">
            <!-- Language Selector -->
            <div class="dropdown me-2">
                <button class="btn btn-sm btn-link text-decoration-none text-gray-400 hover:text-black dropdown-toggle"
                    type="button" data-bs-toggle="dropdown" aria-expanded="false">
                    üåê {{ session.get('lang', 'pt')|upper }}
                </button>
                <ul class="dropdown-menu dropdown-menu-end shadow-sm border-0">
                    <li><a class="dropdown-item small" href="{{ url_for('set_language', lang_code='pt') }}">üáßüá∑ PT</a>
                    </li>
                    <li><a class="dropdown-item small" href="{{ url_for('set_language', lang_code='en') }}">üá∫üá∏ EN</a>
                    </li>
                    <li><a class="dropdown-item small" href="{{ url_for('set_language', lang_code='es') }}">üá™üá∏ ES</a>
                    </li>
                </ul>
            </div>

            <button onclick="requestNotificationPermission()"
                class="p-2 text-gray-400 hover:text-black transition-colors" title="{{ _('Ativar Notifica√ß√µes') }}">
                üîî
            </button>
            <button onclick="openReviewModal()"
                class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-medium transition-colors">
                üìä {{ _('Review Semanal') }}
            </button>
        </div>
    </div>

    <!-- Mood Check-in -->
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm p-6 mb-8 border border-gray-100 dark:border-gray-700">
        <h2 class="text-xl font-medium mb-4 text-center">{{ _('Como voc√™ est√° se sentindo hoje?') }}</h2>
        <div class="flex justify-center gap-4">
            <button onclick="setMood('normal')" id="btn-normal"
                class="px-6 py-3 rounded-full border-2 border-green-500 text-green-600 hover:bg-green-50 transition-all focus:outline-none ring-offset-2 focus:ring-2 ring-green-500 flex items-center gap-2">
                <span>üåû</span> {{ _('Dia Normal') }}
            </button>
            <button onclick="setMood('hard')" id="btn-hard"
                class="px-6 py-3 rounded-full border-2 border-slate-300 text-slate-500 hover:border-orange-400 hover:text-orange-500 hover:bg-orange-50 transition-all focus:outline-none ring-offset-2 focus:ring-2 ring-orange-500 flex items-center gap-2 relative overflow-hidden">
                <span>üåßÔ∏è</span> {{ _('Dia Dif√≠cil') }}
                {% if user.subscription_plan == 'free' %}
                <div
                    class="absolute inset-0 bg-gray-100 bg-opacity-80 flex items-center justify-center cursor-not-allowed">
                    <span class="text-xs font-bold text-gray-500">üîí PRO</span>
                </div>
                {% endif %}
            </button>
        </div>
        <p id="resilience-msg" class="text-center text-sm text-gray-400 mt-4 hidden">
            <span class="font-bold text-orange-500">{{ _('Modo Resili√™ncia Ativo.') }}</span> {{ _('Foco na
            consist√™ncia, n√£o na intensidade.') }}
        </p>
    </div>

    <!-- STREAK HEATMAP (GitHub Style) -->
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm p-6 mb-8 border border-gray-100 dark:border-gray-700">
        <h2 class="text-sm font-bold uppercase tracking-widest text-gray-400 mb-4">{{ _('Const√¢ncia Anual') }}</h2>
        <div class="flex flex-col gap-2 overflow-x-auto pb-2">
            <!-- Grid Container -->
            <div class="flex gap-1" id="heatmap-grid" style="min-width: max-content;">
                <!-- Cells generated by Python Loop -->
                {% set weeks = heatmap_data.keys()|count // 7 %}
                {% if weeks < 52 %}{% set weeks=52 %}{% endif %} {% for i in range(53) %} <!-- 53 columns (weeks) -->
                    <div class="flex flex-col gap-1">
                        {% for j in range(7) %} <!-- 7 rows (days) -->
                        {# Logic to map col/row to date is complex in Jinja.
                        Simplified approach: passing sorted list from backend would be better.
                        For now, using JS to render to be safer and responsive. #}
                        {% endfor %}
                    </div>
                    {% endfor %}
            </div>
            <!-- JS Rendered Canvas Placeholder -->
            <canvas id="heatmapCanvas" height="100" class="w-full"></canvas>
            <div class="flex justify-between text-xs text-gray-400 mt-2 px-1">
                <span>{{ _('Menos') }}</span>
                <div class="flex gap-1">
                    <div class="w-3 h-3 rounded-sm bg-gray-100"></div>
                    <div class="w-3 h-3 rounded-sm bg-green-200"></div>
                    <div class="w-3 h-3 rounded-sm bg-green-400"></div>
                    <div class="w-3 h-3 rounded-sm bg-green-600"></div>
                    <div class="w-3 h-3 rounded-sm bg-green-800"></div>
                </div>
                <span>{{ _('Mais') }}</span>
            </div>
        </div>
    </div>

    <!-- Goals & Systems -->
    <div id="rituals-container" class="space-y-6">
        <!-- Content injected by JS -->
        <div class="animate-pulse flex space-x-4">
            <div class="flex-1 space-y-4 py-1">
                <div class="h-4 bg-gray-200 rounded w-3/4"></div>
                <div class="space-y-2">
                    <div class="h-4 bg-gray-200 rounded"></div>
                    <div class="h-4 bg-gray-200 rounded w-5/6"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add New Goal FAB -->
    <button onclick="openGoalModal()"
        class="fixed bottom-8 right-8 bg-black text-white p-4 rounded-full shadow-lg hover:scale-105 transition-transform z-40">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-12H4" />
        </svg>
    </button>
</div>

<!-- Goal Modal -->
<div id="goal-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white dark:bg-gray-800 rounded-2xl p-8 max-w-md w-full mx-4">
        <h3 class="text-2xl font-light mb-6">Novo Destino</h3>
        <input type="text" id="goal-input" placeholder="Ex: Escrever um livro"
            class="w-full p-4 rounded-xl border border-gray-200 mb-4 focus:ring-2 focus:ring-black focus:outline-none dark:bg-gray-700 dark:border-gray-600">

        <div class="grid grid-cols-2 gap-2 mb-6">
            <button onclick="createRitual('health')" class="p-2 rounded-lg border hover:bg-gray-50 text-sm">üí™
                Corpo</button>
            <button onclick="createRitual('mind')" class="p-2 rounded-lg border hover:bg-gray-50 text-sm">üß†
                Mente</button>
            <button onclick="createRitual('work')" class="p-2 rounded-lg border hover:bg-gray-50 text-sm">üíº
                Trabalho</button>
            <button onclick="createRitual('spirit')" class="p-2 rounded-lg border hover:bg-gray-50 text-sm">üßò
                Esp√≠rito</button>
        </div>

        <div class="flex justify-end gap-3">
            <button onclick="closeGoalModal()" class="text-gray-500 hover:text-black">Cancelar</button>
        </div>
    </div>
</div>

<!-- Upgrade Modal -->
<div id="upgrade-modal" class="fixed inset-0 bg-black bg-opacity-80 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl p-8 max-w-sm w-full mx-4 text-center relative overflow-hidden">
        <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-orange-400 to-red-500"></div>
        <div class="mb-4 text-4xl">ü¶∏‚Äç‚ôÇÔ∏è</div>
        <h3 class="text-2xl font-bold mb-2">Seja Antifr√°gil</h3>
        <p class="text-gray-600 mb-6 font-light leading-relaxed">
            O <strong>Modo Resili√™ncia</strong> ("Dia Dif√≠cil") √© exclusivo do RitualOS Pro. N√£o deixe dias ruins
            quebrarem sua corrente.
        </p>
        <div class="bg-gray-50 rounded-lg p-4 mb-6 text-left border">
            <div class="flex items-center gap-2 mb-2">
                <span class="text-green-500">‚úì</span> <span class="text-sm">Rituais Ilimitados</span>
            </div>
            <div class="flex items-center gap-2 mb-2">
                <span class="text-green-500">‚úì</span> <span class="text-sm font-bold">Modo Resili√™ncia</span>
            </div>
            <div class="flex items-center gap-2">
                <span class="text-green-500">‚úì</span> <span class="text-sm">Coach IA Semanal</span>
            </div>
        </div>
        <a href="{{ url_for('pricing') }}"
            class="block w-full py-3 bg-black text-white rounded-lg font-bold hover:bg-gray-800 transition-colors">
            Upgrade por R$ 29,90
        </a>
        <button onclick="document.getElementById('upgrade-modal').classList.add('hidden')"
            class="mt-4 text-sm text-gray-400 hover:text-gray-600">Agora n√£o</button>
    </div>
</div>

<!-- Review Modal -->
<div id="review-modal"
    class="fixed inset-0 bg-white bg-opacity-95 hidden flex items-center justify-center z-50 overflow-y-auto">
    <div
        class="bg-white rounded-none w-full h-full md:h-auto md:max-w-2xl md:rounded-2xl md:shadow-2xl md:bg-white p-0 flex flex-col">
        <!-- Header -->
        <div class="p-6 border-b flex justify-between items-center sticky top-0 bg-white z-10">
            <div>
                <h2 class="text-2xl font-bold">Review Semanal</h2>
                <p class="text-sm text-gray-500">Kaizen Check-in</p>
            </div>
            <button onclick="document.getElementById('review-modal').classList.add('hidden')"
                class="p-2 hover:bg-gray-100 rounded-full">‚úï</button>
        </div>

        <div class="p-6 flex-1 overflow-y-auto">
            <!-- Stats -->
            <div class="grid grid-cols-7 gap-1 mb-8 text-center" id="review-heatmap">
                <!-- Injected via JS -->
            </div>

            <!-- AI Insight -->
            <div class="bg-blue-50 border border-blue-100 p-6 rounded-xl mb-6">
                <div class="flex items-center gap-3 mb-3">
                    <span class="bg-blue-100 text-blue-600 p-2 rounded-lg">ü§ñ Kaizen AI</span>
                </div>
                <div id="insight-content" class="text-gray-700 leading-relaxed min-h-[100px]">
                    <p class="text-gray-400 italic">Clique em "Gerar An√°lise" para receber feedback da IA sobre sua
                        consist√™ncia...</p>
                </div>
            </div>

            <button onclick="generateInsight()" id="btn-insight"
                class="w-full py-4 bg-black text-white rounded-xl font-bold text-lg hover:bg-gray-800 transition-all flex items-center justify-center gap-2 shadow-lg">
                <span class="animate-pulse">‚ú®</span> Gerar An√°lise de Consist√™ncia
            </button>
        </div>
    </div>
</div>

<!-- Confetti Lib -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<script>
    // URL Configuration (Autogenerated by Flask)
    const apiEndpoints = {
        systems: "{{ url_for('get_rituals') }}",
        generate: "{{ url_for('generate_ritual') }}",
        complete: "{{ url_for('complete_ritual') }}",
        stats: "{{ url_for('get_ritual_stats') }}",
        insight: "{{ url_for('ritual_insight') }}"
    };

    let currentMood = 'normal';
    const userPlan = "{{ user.subscription_plan }}"; // Injected by Flask

    // Init
    document.getElementById('date-display').innerText = new Date().toLocaleDateString('pt-BR', {
        weekday: 'long', day:
            'numeric', month: 'long'
    });
    loadRituals();
    checkNotificationPermission();

    function setMood(mood) {
        // ENFORCEMENT
        document.getElementById('upgrade-modal').classList.remove('hidden');
        return;
    }

    // Call Backend API
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    fetch('/api/set-mood', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
        body: JSON.stringify({ mood: mood })
    });

    currentMood = mood;
    const btnNormal = document.getElementById('btn-normal');
    const btnHard = document.getElementById('btn-hard');
    const msg = document.getElementById('resilience-msg');

    if (mood === 'hard') {
        btnHard.classList.add('bg-orange-50', 'border-orange-500', 'text-orange-600');
        btnNormal.classList.remove('bg-green-50', 'border-green-500', 'text-green-600');
        btnNormal.classList.add('text-gray-400', 'border-gray-200');
        msg.classList.remove('hidden');
    } else {
        btnNormal.classList.add('bg-green-50', 'border-green-500', 'text-green-600');
        btnHard.classList.remove('bg-orange-50', 'border-orange-500', 'text-orange-600');
        btnNormal.classList.remove('text-gray-400', 'border-gray-200');
        msg.classList.add('hidden');
    }
    loadRituals(); // Reload tasks based on mood
    }

    // ... (loadRituals and toggleComplete same as before, no changes needed, just referenced)

    async function loadRituals() {
        const container = document.getElementById('rituals-container');
        let data = [];

        try {
            // Network First
            const res = await fetch(`${apiEndpoints.systems}?mood=${currentMood}`);
            if (res.ok) {
                data = await res.json();
                // Cache for offline
                localStorage.setItem(`cached_rituals_${currentMood}`, JSON.stringify(data));
            } else {
                throw new Error("Network response not ok");
            }
        } catch (e) {
            console.log("Offline or Error, trying cache...");
            const cached = localStorage.getItem(`cached_rituals_${currentMood}`);
            if (cached) {
                data = JSON.parse(cached);
                // Show offline indicator (optional)
            }
        }

        container.innerHTML = '';

        if (!data || data.length === 0) {
            container.innerHTML = `<div class="text-center text-gray-400 py-10">Nenhum ritual definido. Comece pequeno.</div>`;
            return;
        }

        // Apply offline changes from queue if any
        const offlineQueue = JSON.parse(localStorage.getItem('offline_queue') || '[]');
        const offlineCompletedIds = offlineQueue.map(item => item.action_id);

        data.forEach(system => {
            const action = currentMood === 'hard' ? system.action_bad_day : system.action_ideal;
            const duration = system.duration_minutes;
            // Check if completed on server OR locally in queue
            const isCompleted = system.completed || offlineCompletedIds.includes(system.id);
            const streak = system.streak || 0;

            const card = `
<div
    class="p-6 bg-white dark:bg-gray-800 rounded-xl shadow-sm border-l-4 ${currentMood === 'hard' ? 'border-orange-400' : 'border-black'} flex items-center justify-between group hover:shadow-md transition-all ${isCompleted ? 'opacity-70' : ''}">
    <div>
        <div class="flex items-center gap-2 mb-1">
            <span class="text-xs font-bold uppercase tracking-wider text-gray-400">${system.goal_title}</span>
            ${streak > 0 ? `<span class="text-xs font-bold text-orange-500 flex items-center gap-0.5">üî•
                ${streak}</span>` : ''}
        </div>
        <h3 class="text-lg font-medium transition-all ${isCompleted ? 'line-through text-gray-300' : ''}">${action}</h3>
        <div class="text-sm text-gray-400 mt-1 flex gap-2 items-center">
            <span>‚è± ${duration} min</span>
            ${currentMood === 'hard' ? '<span class="text-orange-500 text-xs bg-orange-100 px-2 py-0.5 rounded">Modo Resili√™ncia</span>' : ''}
        </div >
    </div >
                <button onclick="toggleComplete(${system.id}, this)" ${isCompleted ? 'disabled' : ''}
                    class="h-10 w-10 rounded-full border-2 flex items-center justify-center transition-all ${isCompleted ? 'bg-green-500 border-green-500 text-white cursor-default' : 'border-gray-300 hover:border-green-400 text-transparent hover:text-green-400'}">
                    ‚úì
                </button>
</div >
                `;
            container.innerHTML += card;
        });
    }

    async function toggleComplete(actionId, btn) {
        // Obter token do meta tag
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

        // Optimistic UI update
        btn.classList.remove('border-gray-300', 'hover:border-green-400', 'text-transparent', 'hover:text-green-400');
        btn.classList.add('bg-green-500', 'border-green-500', 'text-white');
        btn.disabled = true;

        // Confetti!
        confetti({
            particleCount: 100,
            spread: 70,
            origin: { y: 0.6 }
        });

        const payload = {
            action_id: actionId,
            mood: currentMood
        };

        if (navigator.onLine) {
            try {
                await fetch(apiEndpoints.complete, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify(payload)
                });
                setTimeout(loadRituals, 1000);
            } catch (e) {
                console.error("Failed to complete online, queueing...", e);
                queueOfflineAction(payload);
            }
        } else {
            console.log("Offline, queueing action...");
            queueOfflineAction(payload);
            // Show Toast for Offline Save
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-4 py-2 rounded-full text-sm shadow-lg z-50';
            toast.innerText = 'Salvo offline. Sincronizando quando conectar.';
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
    }

    function queueOfflineAction(payload) {
        const queue = JSON.parse(localStorage.getItem('offline_queue') || '[]');
        // Avoid duplicates
        if (!queue.find(i => i.action_id === payload.action_id)) {
            queue.push(payload);
            localStorage.setItem('offline_queue', JSON.stringify(queue));
        }
    }

    // --- SYNC LOGIC ---
    window.addEventListener('online', syncQueue);

    async function syncQueue() {
        const queue = JSON.parse(localStorage.getItem('offline_queue') || '[]');
        if (queue.length === 0) return;

        // Obter token
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

        console.log("Syncing offline actions...", queue.length);
        const toast = document.createElement('div');
        toast.className = 'fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-blue-600 text-white px-4 py-2 rounded-full text-sm shadow-lg z-50';
        toast.innerText = 'Sincronizando dados...';
        document.body.appendChild(toast);

        let successCount = 0;
        const newQueue = [];

        for (const item of queue) {
            try {
                await fetch(apiEndpoints.complete, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify(item)
                });
                successCount++;
            } catch (e) {
                console.error("Sync failed for item", item, e);
                newQueue.push(item); // Keep in queue if failed
            }
        }

        localStorage.setItem('offline_queue', JSON.stringify(newQueue));

        toast.remove();
        if (successCount > 0) {
            const successToast = document.createElement('div');
            successToast.className = 'fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-green-600 text-white px-4 py-2 rounded-full text-sm shadow-lg z-50';
            successToast.innerText = `${successCount} rituais sincronizados!`;
            document.body.appendChild(successToast);
            setTimeout(() => successToast.remove(), 3000);
            loadRituals(); // Refresh UI
        }
    }

    // Check sync on load too
    if (navigator.onLine) {
        syncQueue();
    }

    async function createRitual(pillar) {
        // Obter token do meta tag se n√£o estiver definido
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

        const input = document.getElementById('goal-input');
        const goal = input.value;
        if (!goal) return;

        const btn = event.target;
        const originalText = btn.innerText;
        btn.innerText = "Criando...";
        btn.disabled = true;

        try {
            const res = await fetch(apiEndpoints.generate, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ goal, pillar })
            });

            const data = await res.json();

            if (res.ok) {
                closeGoalModal();
                loadRituals();
                // Reset button
                btn.innerText = originalText;
                btn.disabled = false;
                input.value = ''; // Clear input
            } else {
                console.error("Server Error:", data);
                alert(data.message || data.error || "Erro ao criar ritual. Verifique o console.");
                btn.innerText = originalText;
                btn.disabled = false;
            }

        } catch (e) {
            console.error("Network/JS Error:", e);
            alert("Erro de conex√£o ou JS: " + e.message);
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }

    function openGoalModal() {
        document.getElementById('goal-modal').classList.remove('hidden');
    }
    function closeGoalModal() {
        document.getElementById('goal-modal').classList.add('hidden');
    }

    // --- NOTIFICATIONS ---
    function requestNotificationPermission() {
        Notification.requestPermission().then(permission => {
            if (permission === "granted") {
                new Notification("RitualOS", {
                    body: "Notifica√ß√µes ativadas! Lembraremos voc√™ de manter a consist√™ncia.",
                    icon: "/static/img/icon.png"
                });
            }
        });
    }

    function checkNotificationPermission() {
        if (Notification.permission === 'granted') {
            // Logic to check if tasks are pending could go here
        }
    }

    // --- WEEKLY REVIEW ---
    async function openReviewModal() {
        document.getElementById('review-modal').classList.remove('hidden');
        const heatmap = document.getElementById('review-heatmap');
        heatmap.innerHTML = '<div class="col-span-7 py-10 text-center text-gray-400">Carregando dados...</div>';

        try {
            const res = await fetch(apiEndpoints.stats);
            const data = await res.json();

            // Build heatmap
            heatmap.innerHTML = '';
            // last 7 days keys
            const sortedDates = Object.keys(data).sort();
            const days = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];

            sortedDates.forEach(dateStr => {
                const count = data[dateStr];
                const date = new Date(dateStr);
                const dayName = days[date.getDay()];
                const intensity = count > 0 ? (count >= 3 ? 'bg-green-500' : 'bg-green-300') : 'bg-gray-100';

                heatmap.innerHTML += `
                < div class="flex flex-col items-center gap-2" >
    <span class="text-xs text-gray-400 uppercase">${dayName}</span>
    <div
        class="w-8 h-8 rounded-lg ${intensity} flex items-center justify-center text-xs font-bold ${count > 0 ? 'text-white' : 'text-gray-300'}">
        ${count > 0 ? count : '-'}
    </div>
</div >
                `;
            });

        } catch (e) {
            heatmap.innerHTML = 'Erro ao carregar';
        }
    }

    async function generateInsight() {
        const btn = document.getElementById('btn-insight');
        const content = document.getElementById('insight-content');
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

        btn.disabled = true;
        btn.innerHTML = `<span class="animate-spin">üåÄ</span> Pensando...`;

        try {
            const res = await fetch(apiEndpoints.insight, {
                method: 'POST',
                headers: { 'X-CSRFToken': csrfToken }
            });
            const data = await res.json();

            content.innerHTML = `<p>${data.insight}</p>`;
            btn.innerHTML = `‚ú® Gerar Novo Insight`;
            btn.disabled = false;
        } catch (e) {
            content.innerHTML = "Erro ao gerar insight.";
            btn.disabled = false;
        }
    }

    // --- HEATMAP RENDERER (Canvas) ---
    function renderHeatmap() {
        // Data injected from Flask
        const rawData = {{ heatmap_data| tojson
    }};
    const canvas = document.getElementById('heatmapCanvas');
    if (!canvas) return; // if section is missing

    const ctx = canvas.getContext('2d');

    // Config
    const cellSize = 10;
    const gap = 2;
    const days = 7;
    const weeks = 53;

    // Resize canvas based on container width? Fixed for now
    canvas.width = (cellSize + gap) * weeks;
    canvas.height = (cellSize + gap) * days;

    // Helper date utils
    const today = new Date();
    const oneYearAgo = new Date();
    oneYearAgo.setDate(today.getDate() - 365);

    // Loop backwards from today? Or forward from 1 year ago?
    // Let's go week by week

    // We need to map dates to (col, row)
    // Col 0 = 1 year ago. Col 52 = This week.

    // Iterating 53 weeks * 7 days
    let currentDate = new Date(oneYearAgo);
    // Align to Sunday of that week
    currentDate.setDate(currentDate.getDate() - currentDate.getDay());

    for (let w = 0; w < weeks; w++) {
        for (let d = 0; d < days; d++) {
            const dateStr = currentDate.toISOString().split('T')[0];
            const count = rawData[dateStr] || 0;

            // Color Logic
            let color = '#f3f4f6'; // gray-100
            if (count === 1) color = '#bbf7d0'; // green-200
            if (count === 2) color = '#4ade80'; // green-400
            if (count === 3) color = '#16a34a'; // green-600
            if (count >= 4) color = '#166534'; // green-800

            // Draw Rect
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.roundRect(w * (cellSize + gap), d * (cellSize + gap), cellSize, cellSize, 2);
            ctx.fill();

            // Next day
            currentDate.setDate(currentDate.getDate() + 1);
        }
    }
    }

    // Trigger render
    renderHeatmap();
    // Re-render on resize?
    window.addEventListener('resize', renderHeatmap);

</script>
{% endblock %}