{% extends "base.html" %}

{% block title %}Dashboard - TaskFlowAI{% endblock %}

{% block extra_css %}
<style>
    .sidebar {
        width: 260px;
        height: calc(100vh - 60px);
        position: fixed;
        left: 0;
        top: 60px;
        background: #f8f9fa;
        padding: 1.5rem;
        overflow-y: auto;
        border-right: 1px solid #e0e0e0;
        transition: transform 0.3s;
    }
    
    .sidebar.collapsed {
        transform: translateX(-100%);
    }
    
    .main-content {
        margin-left: 260px;
        padding: 2rem;
        transition: margin-left 0.3s;
    }
    
    .main-content.expanded {
        margin-left: 0;
    }
    
    .topbar {
        height: 60px;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background: white;
        border-bottom: 1px solid #e0e0e0;
        padding: 0 1.5rem;
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .stat-card {
        border-left: 4px solid var(--primary-color);
    }
    
    @media (max-width: 768px) {
        .sidebar {
            transform: translateX(-100%);
            z-index: 999;
        }
        
        .sidebar.show {
            transform: translateX(0);
        }
        
        .main-content {
            margin-left: 0;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Topbar -->
<div class="topbar">
    <div class="d-flex align-items-center">
        <button class="btn btn-link text-dark me-3" id="sidebarToggle">
            <i class="bi bi-list fs-4"></i>
        </button>
        <h4 class="mb-0 fw-bold text-primary">
            <i class="bi bi-check2-circle"></i> TaskFlowAI
        </h4>
    </div>
    
    <div class="d-flex align-items-center gap-3">
        <div class="input-group" style="width: 300px;">
            <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
            <input type="text" class="form-control" placeholder="Pesquisar...">
        </div>
        
        <div class="dropdown">
            <button class="btn btn-link text-dark position-relative" data-bs-toggle="dropdown">
                <i class="bi bi-bell fs-5"></i>
                {% if notifications %}
                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                    {{ notifications|length }}
                </span>
                {% endif %}
            </button>
            <ul class="dropdown-menu dropdown-menu-end" style="width: 350px; max-height: 400px; overflow-y: auto;">
                <li><h6 class="dropdown-header">Notifica√ß√µes</h6></li>
                {% if notifications %}
                    {% for notif in notifications %}
                    <li><a class="dropdown-item" href="{{ notif.link }}">
                        <strong>{{ notif.title }}</strong><br>
                        <small class="text-muted">{{ notif.content }}</small>
                    </a></li>
                    {% endfor %}
                {% else %}
                    <li><span class="dropdown-item text-muted">Nenhuma notifica√ß√£o</span></li>
                {% endif %}
            </ul>
        </div>
        
        <div class="dropdown">
            <button class="btn btn-link text-dark d-flex align-items-center gap-2" data-bs-toggle="dropdown">
                <img src="/static/avatars/{{ current_user.avatar }}" alt="Avatar" 
                     class="rounded-circle" width="35" height="35"
                     onerror="this.src='https://via.placeholder.com/35'">
                <span class="d-none d-md-inline">{{ current_user.full_name or current_user.username }}</span>
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="/taskflowai/settings"><i class="bi bi-gear me-2"></i>Configura√ß√µes</a></li>
                <li><a class="dropdown-item" href="/taskflowai/settings/subscription"><i class="bi bi-credit-card me-2"></i>Assinatura</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="/taskflowai/logout"><i class="bi bi-box-arrow-right me-2"></i>Sair</a></li>
            </ul>
        </div>
    </div>
</div>

<!-- Sidebar -->
<div class="sidebar" id="sidebar">
    <div class="mb-4">
        <button class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#newItemModal">
            <i class="bi bi-plus-circle me-2"></i>Novo
        </button>
    </div>
    
    <ul class="nav flex-column">
        <li class="nav-item mb-1">
            <a class="nav-link active" href="/taskflowai/dashboard">
                <i class="bi bi-house-door me-2"></i>Dashboard
            </a>
        </li>
        <li class="nav-item mb-1">
            <a class="nav-link" href="{{ url_for('tasks_view') }}">
                <i class="bi bi-check2-square me-2"></i>Minhas Tarefas
            </a>
        </li>
        <li class="nav-item mb-1">
            <a class="nav-link" href="/taskflowai/chat">
                <i class="bi bi-chat-dots me-2"></i>Chat
            </a>
        </li>
        <li class="nav-item mb-1">
            <a class="nav-link" href="/taskflowai/documents">
                <i class="bi bi-file-text me-2"></i>Documentos
            </a>
        </li>
    </ul>
    
    <hr>
    
    <h6 class="text-muted small fw-bold mb-2">WORKSPACES</h6>
    <ul class="nav flex-column">
        {% for workspace in workspaces %}
        <li class="nav-item mb-1">
            <a class="nav-link" href="/taskflowai/workspace/{{ workspace.id }}">
                <span class="me-2">{{ workspace.icon }}</span>{{ workspace.name }}
            </a>
        </li>
        {% endfor %}
    </ul>
    
    <button class="btn btn-outline-primary btn-sm w-100 mt-3">
        <i class="bi bi-plus me-2"></i>Novo Workspace
    </button>
    
    <hr>
    
    <div class="p-3 bg-white rounded text-center">
        <i class="bi bi-robot display-4 text-primary"></i>
        <h6 class="fw-bold mt-2">Assistente IA</h6>
        <p class="small text-muted mb-2">Precisa de ajuda?</p>
        <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#aiHelperModal">Perguntar √† IA</button>
    </div>
</div>

<!-- Main Content -->
<div class="main-content" id="mainContent" style="margin-top: 60px;">
    <h2 class="fw-bold mb-4">Bem-vindo, {{ current_user.full_name or current_user.username }}! üëã</h2>
    
    <!-- Stats Cards -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card stat-card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted mb-1 small">Total de Tarefas</p>
                            <h3 class="fw-bold mb-0">{{ stats.total_tasks }}</h3>
                        </div>
                        <i class="bi bi-check2-square display-4 text-primary opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card stat-card h-100" style="border-left-color: #5AE4C3;">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted mb-1 small">Conclu√≠das</p>
                            <h3 class="fw-bold mb-0">{{ stats.completed_tasks }}</h3>
                        </div>
                        <i class="bi bi-check-circle display-4 opacity-50" style="color: #5AE4C3;"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card stat-card h-100" style="border-left-color: #FFA500;">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted mb-1 small">Atribu√≠das a Mim</p>
                            <h3 class="fw-bold mb-0">{{ stats.assigned_tasks }}</h3>
                        </div>
                        <i class="bi bi-person-check display-4 text-warning opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card stat-card h-100" style="border-left-color: #DC3545;">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted mb-1 small">Pendentes</p>
                            <h3 class="fw-bold mb-0">{{ stats.pending_tasks }}</h3>
                        </div>
                        <i class="bi bi-clock-history display-4 text-danger opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Recent Tasks -->
    <div class="row">
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 fw-bold">Tarefas Recentes</h5>
                    <a href="{{ url_for('tasks_view') }}" class="btn btn-sm btn-outline-primary">Ver todas</a>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        {% if recent_tasks %}
                            {% for task in recent_tasks %}
                            <a href="/taskflowai/task/{{ task.id }}" class="list-group-item list-group-item-action">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <div class="d-flex align-items-center gap-2 mb-1">
                                            <input type="checkbox" class="form-check-input" 
                                                   {% if task.status == 'done' %}checked{% endif %}>
                                            <h6 class="mb-0">{{ task.title }}</h6>
                                            {% if task.priority == 'urgent' %}
                                                <span class="badge bg-danger">Urgente</span>
                                            {% elif task.priority == 'high' %}
                                                <span class="badge bg-warning">Alta</span>
                                            {% endif %}
                                        </div>
                                        <small class="text-muted">
                                            <i class="bi bi-folder me-1"></i>{{ task.project.name }}
                                            {% if task.due_date %}
                                                <i class="bi bi-calendar ms-2 me-1"></i>{{ task.due_date.strftime('%d/%m/%Y') }}
                                            {% endif %}
                                        </small>
                                    </div>
                                    <div class="d-flex align-items-center gap-2">
                                        {% for assignee in task.assignees[:3] %}
                                        <img src="/static/avatars/{{ assignee.avatar }}" 
                                             alt="{{ assignee.username }}" 
                                             class="rounded-circle" width="28" height="28"
                                             onerror="this.src='https://via.placeholder.com/28'"
                                             title="{{ assignee.full_name or assignee.username }}">
                                        {% endfor %}
                                    </div>
                                </div>
                            </a>
                            {% endfor %}
                        {% else %}
                            <div class="text-center py-5">
                                <i class="bi bi-inbox display-1 text-muted"></i>
                                <p class="text-muted mt-3">Nenhuma tarefa recente</p>
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newTaskModal">Criar primeira tarefa</button>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <!-- Quick Actions -->
            <div class="card mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0 fw-bold">A√ß√µes R√°pidas</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary text-start" data-bs-toggle="modal" data-bs-target="#newTaskModal">
                            <i class="bi bi-plus-circle me-2"></i>Nova Tarefa
                        </button>
                        <button class="btn btn-outline-primary text-start" data-bs-toggle="modal" data-bs-target="#newProjectModal">
                            <i class="bi bi-folder-plus me-2"></i>Novo Projeto
                        </button>
                        <button class="btn btn-outline-primary text-start" data-bs-toggle="modal" data-bs-target="#inviteMemberModal">
                            <i class="bi bi-people me-2"></i>Convidar Membro
                        </button>
                        <button class="btn btn-outline-primary text-start" data-bs-toggle="modal" data-bs-target="#aiHelperModal">
                            <i class="bi bi-robot me-2"></i>Gerar com IA
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Subscription Info -->
            <div class="card">
                <div class="card-body text-center">
                    <i class="bi bi-star-fill text-warning fs-1"></i>
                    <h6 class="fw-bold mt-2">Plano {{ current_user.subscription_plan|capitalize }}</h6>
                    <p class="small text-muted mb-3">
                        {% if current_user.subscription_plan == 'free' %}
                        Fa√ßa upgrade para desbloquear mais recursos
                        {% else %}
                        Obrigado por ser nosso cliente!
                        {% endif %}
                    </p>
                    {% if current_user.subscription_plan == 'free' %}
                    <a href="/taskflowai/pricing" class="btn btn-primary btn-sm">Fazer Upgrade</a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Create Modal -->
<div class="modal fade" id="newItemModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Criar novo item</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="list-group">
                    <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" data-bs-toggle="modal" data-bs-target="#newTaskModal" data-bs-dismiss="modal">
                        <span><i class="bi bi-plus-circle me-2"></i>Nova Tarefa</span>
                        <i class="bi bi-arrow-right"></i>
                    </button>
                    <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" data-bs-toggle="modal" data-bs-target="#newProjectModal" data-bs-dismiss="modal">
                        <span><i class="bi bi-folder-plus me-2"></i>Novo Projeto</span>
                        <i class="bi bi-arrow-right"></i>
                    </button>
                    <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" data-bs-toggle="modal" data-bs-target="#inviteMemberModal" data-bs-dismiss="modal">
                        <span><i class="bi bi-people me-2"></i>Convidar Membro</span>
                        <i class="bi bi-arrow-right"></i>
                    </button>
                    <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" data-bs-toggle="modal" data-bs-target="#aiHelperModal" data-bs-dismiss="modal">
                        <span><i class="bi bi-robot me-2"></i>Gerar com IA</span>
                        <i class="bi bi-arrow-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- New Task Modal -->
<div class="modal fade" id="newTaskModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Criar nova tarefa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="newTaskForm" data-endpoint="{{ url_for('api_tasks') }}">
                <div class="modal-body">
                    {% if projects %}
                    <div class="mb-3">
                        <label class="form-label">Projeto</label>
                        <select class="form-select" name="project_id" id="taskProject" required>
                            {% for project in projects %}
                            <option value="{{ project.id }}">{{ project.name }} ¬∑ {{ project.workspace.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    {% else %}
                    <div class="alert alert-warning">
                        Crie um projeto para poder adicionar tarefas.
                    </div>
                    {% endif %}
                    <div class="mb-3">
                        <label class="form-label">T√≠tulo</label>
                        <input type="text" class="form-control" name="title" id="taskTitle" required placeholder="Resumo da tarefa">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Descri√ß√£o</label>
                        <textarea class="form-control" rows="3" name="description" id="taskDescription" placeholder="Detalhes opcionais"></textarea>
                    </div>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Prioridade</label>
                            <select class="form-select" name="priority" id="taskPriority">
                                <option value="low">Baixa</option>
                                <option value="medium" selected>M√©dia</option>
                                <option value="high">Alta</option>
                                <option value="urgent">Urgente</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Entrega</label>
                            <input type="date" class="form-control" name="due_date" id="taskDueDate">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary" {% if not projects %}disabled{% endif %}>Criar tarefa</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- New Project Modal -->
<div class="modal fade" id="newProjectModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Criar novo projeto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="newProjectForm" data-endpoint="{{ url_for('api_projects') }}">
                <div class="modal-body">
                    {% if workspace_options %}
                    <div class="mb-3">
                        <label class="form-label">Workspace</label>
                        <select class="form-select" name="workspace_id" id="projectWorkspace" required>
                            {% for workspace in workspace_options %}
                            <option value="{{ workspace.id }}">{{ workspace.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    {% else %}
                    <div class="alert alert-warning">
                        Nenhum workspace dispon√≠vel. Crie um workspace antes de adicionar projetos.
                    </div>
                    {% endif %}
                    <div class="mb-3">
                        <label class="form-label">Nome do projeto</label>
                        <input type="text" class="form-control" name="name" id="projectName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Descri√ß√£o</label>
                        <textarea class="form-control" rows="3" name="description" id="projectDescription" placeholder="Objetivos do projeto"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary" {% if not workspace_options %}disabled{% endif %}>Criar projeto</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Invite Member Modal -->
<div class="modal fade" id="inviteMemberModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Convidar membro</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="inviteMemberForm">
                <div class="modal-body">
                    {% if workspace_options %}
                    <div class="mb-3">
                        <label class="form-label">Workspace</label>
                        <select class="form-select" id="inviteWorkspace" required>
                            {% for workspace in workspace_options %}
                            <option value="{{ workspace.id }}" data-invite-url="{{ url_for('api_workspace_invite', workspace_id=workspace.id) }}">{{ workspace.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    {% else %}
                    <div class="alert alert-warning">
                        Crie um workspace para enviar convites.
                    </div>
                    {% endif %}
                    <div class="mb-3">
                        <label class="form-label">Email do convidado</label>
                        <input type="email" class="form-control" id="inviteEmail" placeholder="nome@empresa.com" required {% if not workspace_options %}disabled{% endif %}>
                    </div>
                    <div id="inviteResult" class="alert alert-info d-none"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary" {% if not workspace_options %}disabled{% endif %}>Enviar convite</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- AI Helper Modal -->
<div class="modal fade" id="aiHelperModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Assistente IA</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="aiHelperForm" data-endpoint="{{ url_for('api_ai_generate_tasks') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Descreva o que voc√™ precisa</label>
                        <textarea class="form-control" id="aiPrompt" rows="4" placeholder="Ex: Planeje uma campanha de lan√ßamento para o novo produto" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Projeto destino</label>
                        {% if projects %}
                        <select class="form-select" id="aiProject" required>
                            <option value="" disabled selected>Selecione...</option>
                            {% for project in projects %}
                            <option value="{{ project.id }}">{{ project.name }}</option>
                            {% endfor %}
                        </select>
                        {% else %}
                        <div class="alert alert-warning">Crie um projeto para salvar as tarefas geradas pela IA.</div>
                        {% endif %}
                    </div>
                    <div id="aiResults" class="d-none">
                        <h6 class="fw-bold">Tarefas sugeridas</h6>
                        <ul class="list-group" id="aiTasksList"></ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="submit" class="btn btn-primary" {% if not projects %}disabled{% endif %}>Gerar tarefas</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const sidebarToggle = document.getElementById('sidebarToggle');
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.getElementById('mainContent');
    
    sidebarToggle.addEventListener('click', function() {
        if (window.innerWidth <= 768) {
            sidebar.classList.toggle('show');
        } else {
            sidebar.classList.toggle('collapsed');
            mainContent.classList.toggle('expanded');
        }
    });
    
    // Fechar sidebar no mobile ao clicar fora
    document.addEventListener('click', function(event) {
        if (window.innerWidth <= 768) {
            if (!sidebar.contains(event.target) && !sidebarToggle.contains(event.target)) {
                sidebar.classList.remove('show');
            }
        }
    });

    const toastContainer = document.createElement('div');
    toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
    document.body.appendChild(toastContainer);

    const showToast = (message, type = 'success') => {
        const toastEl = document.createElement('div');
        const variant = {
            success: 'success',
            danger: 'danger',
            warning: 'warning',
            info: 'info'
        }[type] || 'primary';
        toastEl.className = `toast align-items-center text-bg-${variant} border-0`;
        toastEl.setAttribute('role', 'alert');
        toastEl.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        `;
        toastContainer.appendChild(toastEl);
        const toast = new bootstrap.Toast(toastEl, { delay: 4000 });
        toast.show();
        toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
    };

    const handleJsonRequest = async (url, payload) => {
        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        const data = await response.json();
        if (!response.ok) {
            throw new Error(data.message || data.error || 'N√£o foi poss√≠vel completar a a√ß√£o');
        }
        return data;
    };

    const closeModal = (modalId) => {
        const modalEl = document.getElementById(modalId);
        if (!modalEl) return;
        const modalInstance = bootstrap.Modal.getInstance(modalEl);
        modalInstance?.hide();
    };

    const newTaskForm = document.getElementById('newTaskForm');
    if (newTaskForm) {
        newTaskForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const endpoint = newTaskForm.dataset.endpoint;
            const payload = {
                title: document.getElementById('taskTitle').value,
                description: document.getElementById('taskDescription').value,
                project_id: document.getElementById('taskProject')?.value,
                priority: document.getElementById('taskPriority').value,
                due_date: document.getElementById('taskDueDate').value || null
            };
            if (!payload.project_id) {
                showToast('Selecione um projeto para criar a tarefa.', 'warning');
                return;
            }
            try {
                await handleJsonRequest(endpoint, payload);
                showToast('Tarefa criada com sucesso!');
                closeModal('newTaskModal');
                setTimeout(() => window.location.href = "{{ url_for('tasks_view') }}", 800);
            } catch (error) {
                showToast(error.message, 'danger');
            }
        });
    }

    const newProjectForm = document.getElementById('newProjectForm');
    if (newProjectForm) {
        newProjectForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const endpoint = newProjectForm.dataset.endpoint;
            const payload = {
                name: document.getElementById('projectName').value,
                description: document.getElementById('projectDescription').value,
                workspace_id: document.getElementById('projectWorkspace')?.value
            };
            try {
                await handleJsonRequest(endpoint, payload);
                showToast('Projeto criado com sucesso!');
                closeModal('newProjectModal');
                setTimeout(() => window.location.reload(), 1000);
            } catch (error) {
                showToast(error.message, 'danger');
            }
        });
    }

    const inviteForm = document.getElementById('inviteMemberForm');
    const inviteResult = document.getElementById('inviteResult');
    if (inviteForm) {
        inviteForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const workspaceSelect = document.getElementById('inviteWorkspace');
            const endpoint = workspaceSelect?.selectedOptions[0]?.dataset.inviteUrl;
            if (!endpoint) {
                showToast('Selecione um workspace v√°lido', 'warning');
                return;
            }
            const payload = { email: document.getElementById('inviteEmail').value };
            try {
                const data = await handleJsonRequest(endpoint, payload);
                if (data.invite_link) {
                    inviteResult.classList.remove('d-none');
                    inviteResult.innerHTML = `Convite gerado! Compartilhe este link:<br><strong>${data.invite_link}</strong>`;
                } else {
                    inviteResult.classList.add('d-none');
                    inviteResult.innerHTML = '';
                    closeModal('inviteMemberModal');
                    showToast('Usu√°rio adicionado ao workspace!');
                }
            } catch (error) {
                showToast(error.message, 'danger');
            }
        });
    }

    document.getElementById('inviteMemberModal')?.addEventListener('hidden.bs.modal', () => {
        if (inviteResult) {
            inviteResult.classList.add('d-none');
            inviteResult.innerHTML = '';
        }
        inviteForm?.reset();
    });

    const aiForm = document.getElementById('aiHelperForm');
    const aiResults = document.getElementById('aiResults');
    const aiTasksList = document.getElementById('aiTasksList');
    const projectUrlTemplate = "{{ url_for('project_detail', project_id=0) }}";
    if (aiForm) {
        aiForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            aiResults?.classList.add('d-none');
            aiTasksList.innerHTML = '';
            const endpoint = aiForm.dataset.endpoint;
            const projectSelect = document.getElementById('aiProject');
            if (projectSelect && !projectSelect.value) {
                showToast('Selecione um projeto para salvar as tarefas geradas.', 'warning');
                return;
            }
            const payload = {
                description: document.getElementById('aiPrompt').value,
                project_id: projectSelect ? projectSelect.value : null
            };
            try {
                const data = await handleJsonRequest(endpoint, payload);
                if (data.tasks && data.tasks.length) {
                    aiResults.classList.remove('d-none');
                    data.tasks.forEach((task) => {
                        const item = document.createElement('li');
                        item.className = 'list-group-item';
                        const projectId = task.project_id || payload.project_id;
                        const projectLink = projectId ? projectUrlTemplate.replace('0', String(projectId)) : '';
                        item.innerHTML = `
                            <div class="d-flex justify-content-between gap-3">
                                <div>
                                    <h6 class="mb-1">${task.title}</h6>
                                    <p class="mb-0 text-muted small">${task.description || 'Sem descri√ß√£o'}</p>
                                </div>
                                ${projectLink ? `<a href="${projectLink}" class="btn btn-sm btn-outline-primary">Ver projeto</a>` : ''}
                            </div>
                        `;
                        aiTasksList.appendChild(item);
                    });
                    showToast('Tarefas geradas com sucesso!');
                } else {
                    showToast('A IA n√£o retornou sugest√µes desta vez.', 'warning');
                }
            } catch (error) {
                showToast(error.message, 'danger');
            }
        });
    }
</script>
{% endblock %}
