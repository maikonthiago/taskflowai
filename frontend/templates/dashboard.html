{% extends 'base.html' %}

{% block title %}Dashboard - TaskFlowAI{% endblock %}

{% block extra_css %}
<style>
    .stats-card {
        transition: all 0.3s ease;
        border: none;
        border-radius: 15px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        height: 100%;
    }

    .stats-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
    }

    .stats-card .card-body {
        padding: 1.5rem;
    }

    .stats-icon {
        width: 60px;
        height: 60px;
        border-radius: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.8rem;
    }

    .stats-icon.primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .stats-icon.warning {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
    }

    .stats-icon.success {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
    }

    .stats-icon.info {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        color: white;
    }

    .stats-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--dark-color);
        margin: 0.5rem 0 0 0;
    }

    .stats-label {
        color: #64748b;
        font-size: 0.875rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .section-header {
        margin-bottom: 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .section-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--dark-color);
        margin: 0;
    }

    .project-card {
        transition: all 0.3s ease;
        border: none;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        height: 100%;
        overflow: hidden;
    }

    .project-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
    }

    .project-card .card-body {
        padding: 1.5rem;
    }

    .project-name {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--dark-color);
        margin-bottom: 0.5rem;
        display: -webkit-box;
        -webkit-line-clamp: 1;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .project-description {
        color: #64748b;
        font-size: 0.875rem;
        margin-bottom: 1rem;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        min-height: 2.5rem;
    }

    .project-meta {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
        font-size: 0.75rem;
        color: #94a3b8;
    }

    .task-card {
        background: white;
        border-radius: 10px;
        padding: 1.25rem;
        margin-bottom: 1rem;
        border-left: 4px solid #e2e8f0;
        transition: all 0.3s ease;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
    }

    .task-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transform: translateX(4px);
    }

    .task-card.priority-urgent {
        border-left-color: #ef4444;
    }

    .task-card.priority-high {
        border-left-color: #f59e0b;
    }

    .task-card.priority-medium {
        border-left-color: #3b82f6;
    }

    .task-card.priority-low {
        border-left-color: #10b981;
    }

    .task-title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--dark-color);
        margin-bottom: 0.5rem;
    }

    .task-description {
        color: #64748b;
        font-size: 0.875rem;
        margin-bottom: 0.75rem;
    }

    .task-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 0.5rem;
        font-size: 0.75rem;
        color: #94a3b8;
    }

    .badge {
        padding: 0.35rem 0.75rem;
        font-weight: 600;
        border-radius: 6px;
    }

    .badge-urgent {
        background: #fee2e2;
        color: #991b1b;
    }

    .badge-high {
        background: #fef3c7;
        color: #92400e;
    }

    .badge-medium {
        background: #dbeafe;
        color: #1e40af;
    }

    .badge-low {
        background: #d1fae5;
        color: #065f46;
    }

    .empty-state {
        text-align: center;
        padding: 3rem 1rem;
        color: #94a3b8;
    }

    .empty-state i {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    .empty-state h4 {
        color: #64748b;
        margin-bottom: 0.5rem;
    }

    .skeleton {
        animation: skeleton-loading 1s linear infinite alternate;
        background: linear-gradient(90deg, #f1f5f9 0%, #e2e8f0 50%, #f1f5f9 100%);
        border-radius: 8px;
    }

    @keyframes skeleton-loading {
        0% {
            background-position: -200px 0;
        }
        100% {
            background-position: calc(200px + 100%) 0;
        }
    }

    .skeleton-card {
        height: 150px;
        margin-bottom: 1rem;
    }

    @media (max-width: 768px) {
        .stats-value {
            font-size: 1.5rem;
        }

        .section-header {
            flex-direction: column;
            align-items: flex-start;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Welcome Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
            <div>
                <h1 class="h2 mb-2">
                    <i class="bi bi-house-door-fill me-2"></i>
                    Bem-vindo, <span id="userName">Usuário</span>!
                </h1>
                <p class="text-muted mb-0">
                    <i class="bi bi-calendar3 me-2"></i>
                    <span id="currentDate"></span>
                </p>
            </div>
            <div>
                <button class="btn btn-primary" onclick="createProject()">
                    <i class="bi bi-plus-circle me-2"></i>Novo Projeto
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row g-3 mb-4">
    <div class="col-12 col-sm-6 col-lg-3">
        <div class="card stats-card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <p class="stats-label mb-0">Pendentes</p>
                        <h3 class="stats-value" id="pendingTasks">
                            <span class="skeleton" style="display: inline-block; width: 50px; height: 2rem;"></span>
                        </h3>
                    </div>
                    <div class="stats-icon primary">
                        <i class="bi bi-list-check"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-12 col-sm-6 col-lg-3">
        <div class="card stats-card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <p class="stats-label mb-0">Em Progresso</p>
                        <h3 class="stats-value" id="inProgressTasks">
                            <span class="skeleton" style="display: inline-block; width: 50px; height: 2rem;"></span>
                        </h3>
                    </div>
                    <div class="stats-icon warning">
                        <i class="bi bi-hourglass-split"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-12 col-sm-6 col-lg-3">
        <div class="card stats-card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <p class="stats-label mb-0">Concluídas</p>
                        <h3 class="stats-value" id="completedTasks">
                            <span class="skeleton" style="display: inline-block; width: 50px; height: 2rem;"></span>
                        </h3>
                    </div>
                    <div class="stats-icon success">
                        <i class="bi bi-check-circle-fill"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-12 col-sm-6 col-lg-3">
        <div class="card stats-card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <p class="stats-label mb-0">Projetos Ativos</p>
                        <h3 class="stats-value" id="activeProjects">
                            <span class="skeleton" style="display: inline-block; width: 50px; height: 2rem;"></span>
                        </h3>
                    </div>
                    <div class="stats-icon info">
                        <i class="bi bi-folder-fill"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Projects Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="section-header">
            <h2 class="section-title">
                <i class="bi bi-folder me-2"></i>Projetos Recentes
            </h2>
            <button class="btn btn-outline-primary" onclick="window.location.href='/projects'">
                <i class="bi bi-arrow-right me-1"></i>Ver todos
            </button>
        </div>
        <div id="projectsList" class="row g-3">
            <!-- Loading skeletons -->
            <div class="col-12 col-md-6 col-lg-4">
                <div class="skeleton skeleton-card"></div>
            </div>
            <div class="col-12 col-md-6 col-lg-4">
                <div class="skeleton skeleton-card"></div>
            </div>
            <div class="col-12 col-md-6 col-lg-4">
                <div class="skeleton skeleton-card"></div>
            </div>
        </div>
    </div>
</div>

<!-- Urgent Tasks Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="section-header">
            <h2 class="section-title">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>Tarefas Urgentes
            </h2>
            <button class="btn btn-outline-primary" onclick="window.location.href='/tasks'">
                <i class="bi bi-arrow-right me-1"></i>Ver todas
            </button>
        </div>
        <div id="urgentTasks">
            <!-- Loading skeleton -->
            <div class="skeleton skeleton-card"></div>
        </div>
    </div>
</div>

<!-- Create Project Modal -->
<div class="modal fade" id="createProjectModal" tabindex="-1" aria-labelledby="createProjectModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createProjectModalLabel">
                    <i class="bi bi-folder-plus me-2"></i>Criar Novo Projeto
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createProjectForm" novalidate>
                    <div class="mb-3">
                        <label for="projectName" class="form-label">
                            <i class="bi bi-pencil me-1"></i>Nome do Projeto *
                        </label>
                        <input type="text" class="form-control" id="projectName" 
                               placeholder="Digite o nome do projeto" required>
                        <div class="invalid-feedback">
                            Por favor, insira o nome do projeto
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="projectDescription" class="form-label">
                            <i class="bi bi-text-paragraph me-1"></i>Descrição
                        </label>
                        <textarea class="form-control" id="projectDescription" rows="3" 
                                  placeholder="Descreva o projeto (opcional)"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="projectWorkspace" class="form-label">
                            <i class="bi bi-collection me-1"></i>Workspace *
                        </label>
                        <select class="form-select" id="projectWorkspace" required>
                            <option value="">Carregando...</option>
                        </select>
                        <div class="invalid-feedback">
                            Por favor, selecione um workspace
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="submitProject()" id="submitProjectBtn">
                    <i class="bi bi-check-circle me-1"></i>Criar Projeto
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="/static/js/main.js"></script>
<script>
    let refreshInterval;

    // Display current date
    function displayDate() {
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        const date = new Date().toLocaleDateString('pt-BR', options);
        document.getElementById('currentDate').textContent = date.charAt(0).toUpperCase() + date.slice(1);
    }

    // Load user name
    function loadUserName() {
        try {
            const userStr = localStorage.getItem('user') || sessionStorage.getItem('user');
            if (userStr) {
                const user = JSON.parse(userStr);
                document.getElementById('userName').textContent = user.full_name || user.username || 'Usuário';
            }
        } catch (error) {
            console.error('Error loading user name:', error);
        }
    }

    // Load statistics
    async function loadStats() {
        try {
            const tasks = await apiRequest('/api/tasks');

            const pending = tasks.filter(t => t.status === 'to_do' || t.status === 'pending').length;
            const inProgress = tasks.filter(t => t.status === 'in_progress').length;
            const completed = tasks.filter(t => t.status === 'completed' || t.status === 'done').length;

            document.getElementById('pendingTasks').textContent = pending;
            document.getElementById('inProgressTasks').textContent = inProgress;
            document.getElementById('completedTasks').textContent = completed;
        } catch (error) {
            console.error('Error loading stats:', error);
            document.getElementById('pendingTasks').textContent = '0';
            document.getElementById('inProgressTasks').textContent = '0';
            document.getElementById('completedTasks').textContent = '0';
        }
    }

    // Load projects
    async function loadProjects() {
        try {
            const projects = await apiRequest('/api/projects');

            const active = projects.filter(p => p.status === 'active').length;
            document.getElementById('activeProjects').textContent = active;

            const projectsList = document.getElementById('projectsList');

            if (projects.length === 0) {
                projectsList.innerHTML = `
                    <div class="col-12">
                        <div class="empty-state">
                            <i class="bi bi-folder-x"></i>
                            <h4>Nenhum projeto encontrado</h4>
                            <p>Crie seu primeiro projeto para começar!</p>
                            <button class="btn btn-primary" onclick="createProject()">
                                <i class="bi bi-plus-circle me-2"></i>Criar Projeto
                            </button>
                        </div>
                    </div>
                `;
                return;
            }

            projectsList.innerHTML = projects.slice(0, 6).map(project => `
                <div class="col-12 col-md-6 col-lg-4">
                    <div class="card project-card">
                        <div class="card-body">
                            <h6 class="project-name">${escapeHtml(project.name)}</h6>
                            <p class="project-description">${escapeHtml(project.description || 'Sem descrição')}</p>
                            <div class="project-meta">
                                <span><i class="bi bi-calendar3 me-1"></i>${formatDate(project.created_at)}</span>
                                <span><i class="bi bi-check2-square me-1"></i>${project.task_count || 0} tarefas</span>
                            </div>
                            <div class="d-flex gap-2">
                                <a href="/taskflowai/project/${project.id}" class="btn btn-primary btn-sm flex-fill">
                                    <i class="bi bi-box-arrow-up-right me-1"></i>Abrir
                                </a>
                                <button class="btn btn-outline-secondary btn-sm" onclick="shareProject('${project.id}')" title="Compartilhar">
                                    <i class="bi bi-share"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        } catch (error) {
            console.error('Error loading projects:', error);
            document.getElementById('projectsList').innerHTML = `
                <div class="col-12">
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>Erro ao carregar projetos
                    </div>
                </div>
            `;
            document.getElementById('activeProjects').textContent = '0';
        }
    }

    // Load urgent tasks
    async function loadUrgentTasks() {
        try {
            const tasks = await apiRequest('/api/tasks');
            const urgentTasks = tasks.filter(t => 
                (t.priority === 'urgent' || t.priority === 'high') && 
                t.status !== 'completed' && 
                t.status !== 'done'
            ).slice(0, 5);

            const container = document.getElementById('urgentTasks');

            if (urgentTasks.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-check-circle"></i>
                        <h4>Nenhuma tarefa urgente</h4>
                        <p>Ótimo trabalho! Não há tarefas urgentes no momento.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = urgentTasks.map(task => `
                <div class="task-card priority-${task.priority}">
                    <h6 class="task-title">${escapeHtml(task.title)}</h6>
                    <p class="task-description">${escapeHtml(task.description || 'Sem descrição')}</p>
                    <div class="task-meta">
                        <span>
                            <i class="bi bi-calendar-event me-1"></i>
                            ${task.due_date ? formatDate(task.due_date) : 'Sem prazo'}
                        </span>
                        <span class="badge badge-${task.priority}">
                            ${getPriorityLabel(task.priority)}
                        </span>
                    </div>
                </div>
            `).join('');
        } catch (error) {
            console.error('Error loading urgent tasks:', error);
            document.getElementById('urgentTasks').innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>Erro ao carregar tarefas
                </div>
            `;
        }
    }

    // Load workspaces for project creation
    async function loadWorkspaces() {
        try {
            const workspaces = await apiRequest('/api/workspaces');
            const select = document.getElementById('projectWorkspace');

            select.innerHTML = '<option value="">Selecione um workspace...</option>' +
                workspaces.map(w => `<option value="${w.id}">${escapeHtml(w.name)}</option>`).join('');
        } catch (error) {
            console.error('Error loading workspaces:', error);
            const select = document.getElementById('projectWorkspace');
            select.innerHTML = '<option value="">Erro ao carregar workspaces</option>';
        }
    }

    // Create project modal
    function createProject() {
        loadWorkspaces();
        document.getElementById('createProjectForm').reset();
        document.getElementById('createProjectForm').classList.remove('was-validated');
        const modal = new bootstrap.Modal(document.getElementById('createProjectModal'));
        modal.show();
    }

    // Submit project
    async function submitProject() {
        const form = document.getElementById('createProjectForm');
        
        if (!form.checkValidity()) {
            form.classList.add('was-validated');
            return;
        }

        const name = document.getElementById('projectName').value;
        const description = document.getElementById('projectDescription').value;
        const workspace_id = document.getElementById('projectWorkspace').value;

        const btn = document.getElementById('submitProjectBtn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Criando...';

        try {
            const project = await apiRequest('/api/projects', 'POST', { 
                name, 
                description, 
                workspace_id: parseInt(workspace_id)
            });

            showAlert('Projeto criado com sucesso!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('createProjectModal')).hide();
            loadProjects();
            
            // Redirect to project page after 1 second
            setTimeout(() => {
                window.location.href = `/project/${project.id}`;
            }, 1000);
        } catch (error) {
            console.error('Error creating project:', error);
            showAlert(error.message || 'Erro ao criar projeto', 'danger');
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-check-circle me-1"></i>Criar Projeto';
        }
    }

    // Share project (placeholder)
    function shareProject(projectId) {
        showAlert('Funcionalidade de compartilhamento em desenvolvimento!', 'info');
    }

    // Helper functions
    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        const date = new Date(dateString);
        return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
    }

    function getPriorityLabel(priority) {
        const labels = {
            'urgent': 'Urgente',
            'high': 'Alta',
            'medium': 'Média',
            'low': 'Baixa'
        };
        return labels[priority] || priority;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function showAlert(message, type = 'info') {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(alertDiv);
        setTimeout(() => alertDiv.remove(), 5000);
    }

    // Auto-refresh data every 30 seconds
    function startAutoRefresh() {
        refreshInterval = setInterval(() => {
            loadStats();
            loadProjects();
            loadUrgentTasks();
        }, 30000);
    }

    function stopAutoRefresh() {
        if (refreshInterval) {
            clearInterval(refreshInterval);
        }
    }

    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function() {
        displayDate();
        loadUserName();
        loadStats();
        loadProjects();
        loadUrgentTasks();
        startAutoRefresh();
    });

    // Clean up on page unload
    window.addEventListener('beforeunload', function() {
        stopAutoRefresh();
    });

    // Refresh on visibility change
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden) {
            loadStats();
            loadProjects();
            loadUrgentTasks();
        }
    });
</script>
{% endblock %}
